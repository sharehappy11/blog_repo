---
title: 高并发红包设计方案
date: 2019-11-16 22:55:27
categories: 项目
---
在线用户做抢红包活动，所有APP可见红包消息，并发高。经过学习记录一下整体的设计思路。

## 产品需求

1. 所有在线用户收到消息后，都可以跳到红包页面等待红包开启；
2. 抽到吉利数字，需要全网飘屏通知；
3. 红包不能超发，不能有剩余，满足最小金额的情况下覆盖尽量广的用户。

## 难点与解决思路

### 瞬时流量大

抢红包、秒杀类的业务都有这种情况，用户同一时间点请求导致流量高过平时数倍，容易压垮服务器。
**解决思路：限流**
在所有能限流的地方限流，减少需要服务器处理的请求。

1. 抢购页面使用静态页，缓解服务端带宽压力。
2. 客户端限流，在用户进入抢购页面时根据一定规则决定是否可以抢红包，不符合规则的在点击抢红包时可以发送请求后给与提示。
3. 服务端限流，评估服务器能承载的最大请求数N，在用户点击时通过redis incr接口计数，处理完成后减掉计数。当计数大于N时提示用户"当前请求过多，请稍后重试"，或者客户端等待一段时间后在重发请求。

### 红包不超发和吉利数字飘屏

红包金额存储在mysql，每次点击时通过随机去计算金额，为避免超发需要为字段增加锁，如
```update amount=amount-rand where amount>rand;```可能会造成失败重试，因为有锁响应会受到mysql的限制。

**解决思路：红包金额预分配**
红包个数根据总额、业务规则、抢购页面当前总人数等信息提前分好，塞入redis的List中，在领取时使用lpop保证原子性操作。预分配： 能保证红包金额不超发，并可提前生成吉利金额红包。根据抢购页总人数提高红包数量，可确保红包覆盖更广的用户数。

另外，预分配后可以写入多个redis实例中，如按机房分配、按用户尾号分配等，把红包拆到N个redis中，共同承担红包领取的流量可以有效的避免单机压力，提高系统的稳定性与响应速度。

### 红包金额实时到账

红包领取时同步更新用户余额，因为都是和更新同一张表，所以效率会受到影响。建议使用异步消息机制，后端消费信息去更新用户余额，并与redis中的领取记录对账，保障用户红包都按实发放。

监控领取redis即发放记录，实时对账确保没有用户漏发等bug。

## 总结

解决此类问题的思路，就是要对实际场景进行拆分。把可以提前做的操作前置，实时性要求不高的异步后置，在所有可能的地方拦截流量（并做好预案），以此确保服务的高可用。
